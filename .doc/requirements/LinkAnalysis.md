# 链路分析模块

## 变更记录

| 版本 | 修改人 | 修改时间  |
| :--: | :----: | :-------: |
| V1.0 |  张萍  | 2020/2/12 |
| V2.0 |  张萍  | 2020/2/16 |

## 一、概述

​	一个复杂的微服务架构的应用通常由众多微服务构成，节点众多，节点直接的拓扑结构复杂，出现问题时，难以定位问题发生的位置。链路分析模块本质上就是**描绘分布式系统中一次完整调用**，包括从用户界面的请求到数据库的读写。

## 二、链路分析功能点介绍

### 2.1 链路列表和搜索模块

用户可以查看某一段时间内的链路访问列表。属性包括时间、微服务名、请求结果、耗时……等数据，且可以通过限定条件对链路进行过滤，搜索符合用户期望的链路。

### 2.2 链路查询模块

链路查询是整个链路分析模块的核心功能。链路查询模块的工作原理如下

	1. 根据TraceID向日志模块/搜索引擎查询相关链路日志
	2. 对日志数据进行预处理，并结构化
	3. 对重复调用进行折叠，使链路结构清晰简洁（主要指失败重试的调用，影响链路分析）
	4. 将结构化数据返回给前端页面，进行渲染

| 符号    | 含义                                                  | 生成规则                                                     |
| ------- | ----------------------------------------------------- | ------------------------------------------------------------ |
| TraceID | 标注分布式链路的ID，具有唯一性，不同链路有不同TraceID | 根据请求起始点的IP、请求时间、进程号、随机数等信息生成一个长度固定的唯一ID，保证不会重复。 |
| SpanID  | 用于表示服务和服务之间的调用/信息传递关系             | 在一次分布式调用中，spanID从0开始，随着发生RPC、HTTP请求、DB调用等递增，跨节点时用“.”进行分割 |

通过集成的开源框架Zipkin，对链路追踪结果进行结构化树形显示，报错各个微服务节点，节点之间的调用关系（请求时间、请求结果、请求方式……）

### 2.3 链路收藏模块

链路收藏模块是比较简单的模块，用户可以将自己关注的链路收藏起来。一方面，某个链路可能具有代表意义，需要回顾分析；另一方面，日志链路的日志量巨大，保存时间不会太长，日志被删除之后链路会随着消失，被收藏的链路会另外存储到数据库持久保存。

收藏链路时建立相应的数据结构，包括收藏着、收藏时间、标题、描述信息等等，并有一个唯一的ID，以便日后查询。

### 2.4 链路监控模块 

链路监控模块需要日志收集模块的配合。日志模块采集需要的业务日志，监控模块间隔指定时间触发定时任务，统计业务日志的成功失败情况，当失败率达到阈值，会通知相关业务人员。

监控的规则需要用户提前配置，包括日志的路径、切分日志的字段、业务成功的判断条件、报警阈值、相关人员配置等信息。如果日志字段包括TraceID，监控模块将查询对应链路并分析，将信息一同呈现给用户。

### 2.5 链路服务权限管理模块

该模块对用户权限进行判断和过滤，管理员可以配置哪些角色成员可以访问哪些微服务/api。权限采用分层机制，高层级的角色可以继承低层级角色的全部权限。该模块可能需要和其他模块共同完成。

## 三、与其他模块的关系

### 3.1 与监控模块

查询某链路时，若需要查看该链路的失败原因等具体信息，需要依赖监控模块的信息。

## 四、功能点分析

|                           用户故事                           |                            功能点                            |  M   |  S   |  C   |  W   |     约束     | 估时/人日 |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :--: | :--: | :--: | :--: | :----------: | :-------: |
|             作为用户，我希望能够查看链路请求列表             |                       显示链路调用列表                       |  Y   |      |      |      |              |     3     |
|                                                              |                  选择列表项可以查看详细信息                  |  Y   |      |      |      |              |     2     |
|                                                              |                分页显示功能及根据条件筛选过滤                |  Y   |      |      |      |              |     2     |
|          作为用户，我希望能够可视化显示链路调用过程          |              显示调用节点以及节点之间的拓扑关系              |  Y   |      |      |      |              |     4     |
|                                                              | 点击节点和节点之间的连线可以显示请求时间、请求方式和结果等具体信息 |  Y   |      |      |      |              |     3     |
|      作为用户，我希望能够保留认为有意义的链路，快速重现      |                         增加收藏链路                         |  Y   |      |      |      |              |     1     |
|                                                              |                         编辑收藏链路                         |  Y   |      |      |      |              |     1     |
|                                                              |                         删除收藏链路                         |  Y   |      |      |      |              |     1     |
|  作为用户，我希望能在系统失败率达到一定程度时，能够及时得知  |       触发定时任务，分析一定时间内的链路调用成功失败率       |      |  Y   |      |      |              |     3     |
|                                                              |                       通知相关业务人员                       |      |  Y   |      |      |              |     2     |
| 作为用户，我希望不同级别的人员拥有不同的权限，而不是所有人都能看见全部链路 |             为用户增加权限，扩展能查看的链路范围             |      |      |      |  Y   | 成员权限管理 |     1     |
|                                                              |                       取消用户查看权限                       |      |      |      |  Y   | 成员权限管理 |     1     |

