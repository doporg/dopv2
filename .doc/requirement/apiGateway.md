# api网关管理

## 历史版本

| 版本 | 修改内容             | 修改人 | 修改日期   |
| :--- | -------------------- | ------ | ---------- |
| v1.0 | 初始版本             | 蔡迪希 | 2020-02-21 |
| v1.1 | 细化策略配置、监控   | 蔡迪希 | 2020-02-25 |
| v1.2 | 细化功能点介绍、分析 | 蔡迪希 | 2020-02-28 |

## 一、概述
  该模块提供所有微服务对外api的管理服务，包括API 创建、维护、发布、运行、下线等操作的全生命周期管理。同时提供可视化监控与交互式配置等服务。



## 二、api网关管理功能点介绍
### 2.1	api生命周期管理
api生命周期管理提供 API 创建、维护、上线、运行、下线等操作的全生命周期管理。

用户点击导航栏中的api管理，进入api生命周期管理界面

####2.1.1	创建api

​	在api生命周期管理界面中，用户点击创建api按钮，进行api的初始创建，初始创建api时首先进行入口配置，需要填写以下信息：

* api名称

* 状态：上线或下线，上线才可以接受用户请求

* 请求方法：外部请求来源方式，分为：ALL、GET、POST、PUT、DELETE

* 请求路径：外部用户的请求路径，可选择是否匹配所有子路径

* 请求参数：请求所用到的参数，包含参数名称、参数位置（head、parameter path等）、参数类型（string、int等）、默认值、示例、描述等

在完成入口后，用户点击下一步进行转发配置，转发配置需要填写以下信息：

* 路由策略：用户可以选择已有的策略或创建新的路由策略，详情见2.2.3
* 后端超时：定义请求的超时时间，访问此API处理时间超出设定时间后，系统将会阻止此请求的访问，避免请求持续占用资源
* 网关缓存：开启缓存设置，程序端将会从您开始设置时间保存第一次请求API结果数据，后期同样的请求将从缓存区域返回请求结果，提高响应效率

用户还可以进行以下高级设置

* 流控策略：用户可以选择已有的策略或创建新的流控策略，详情见2.2.1

* 熔断策略：用户可以选择已有的策略或创建新的熔断策略，详情见2.2.2



####2.1.2	上线/下线api

​	在API调用或是API转发到的服务出现问题时，为了避免返回数据错误造成损失，可以将API点击下线，在完成修复后，可点击API上线，恢复调用。

​	在api生命周期管理界面中，用户可以在api列表中点击列表操作“上线”/“下线”按钮，进行api的上线/下线。

####2.1.3	修改api

在API列表中可修改API，更改API的配置，生效到后续调用中。

在api生命周期管理界面中，用户可以在api列表中点击列表操作“修改”按钮，进行api的修改。修改完成后，点击“确认”按钮完成确认

#### 2.1.4	删除api

如果API不再使用，可以将API进行删除。

在api生命周期管理界面中，用户可以在api列表中点击列表操作“删除”按钮，进行api的删除。

#### 2.1.5	api详情

在api详情页，可以查看api的详情

在api生命周期管理界面中，用户可以在api列表中点击需要查看详情的api名称，进入api详情页。api详情页包括总览、基本配置、高级配置。

用户在总览中可以看到：

* api的请求数：30分钟内的请求访问总量和失败率，以折线图的形式展示

* 平均响应时间：30分钟内请求数的平均耗时，以柱状图的形式展示

* 熔断情况

  

### 2.2	api策略配置

​	该功能点为用户提供api相关的策略配置服务，允许用户为不同的api的设置具体策略，包括流控策略，熔断策略、路由策略等

#### 2.2.1 流控策略

系统可以根据系统的流量控制策略验证api是否达到请求上限

* 用户可以选择启用或关闭限流策略

* 可以为api绑定具体的策略，包括限流策略（例如：10次/60s）和配额策略（1000次），也可以同时绑定多个策略（会先执行范围较小的策略）

#### 2.2.2 熔断策略

熔断用于对访问出现大量失败的 API 进行熔断控制，阻止请求对 API 的访问，返回 400，在 API 修复一段时间后，进行尝试接收部分访问请求，如果这部分请求的错误率比较低，那么认定 API 恢复健康状态，正常接收所有请求访问。

* 用户可以选择启用或关闭熔断策略

* 用户可以设置熔断检测环大小：校验环内的请求数的数量

* 用户可以设置临界熔断失败率：用于判断API 是否达到熔断条件

* 用户可以设置熔断持续时间：API 在熔断后修复的一段时间

* 用户可以设置恢复检测环大小：检测API 新的请求过来是否恢复正常

#### 2.2.3 路由策略

API 只有绑定路由策略，请求才能获得返回内容，因为路由策略内设置的地址为实际可返回结果地址，绑定之后网关将进行请求转发。

* 可绑定的路由策略包括：IP、权重、服务发现、头信息，用户可以绑定多个路由策略，转发根据绑定顺序的策略依次匹配：如果首先绑定权重策略或服务发现策略，则API请求为全中，如果首先绑定IP策略或header策略，则API请求则进行检查匹配再选中，未选中的依次再向后绑定的策略匹配

 

###2.3	api监控

  该功能点为用户提供可视化的监控信息。可方便的查询运行中 API 的详细信息。方便用户的运维管理。为用户对自身 API 的分析提供方便可靠的数据依据。以便 API 的后期迭代与维护，提高效率。

#### 2.3.1	流量统计

​	流量统计可查看一段时间内网关整体的请求转发情况，以统计表格的形式展现api的被调用情况

（1）提供柱状图显示网关在一定时间内的总体请求数情况，体现总体请求的成功数，失败数以及平均响应时间

（2）用户可以查看网关网关整体请求的平均吞吐量

（3）用户可以查看网关整体请求的错误率

（4）用户可以查看网关中被频繁调用的API（前5）；调用错误率最高的API（前5）；调用耗时最久的API（前5）；

#### 2.3.2	请求日志

​	显示API网关中API接口的请求日志信息，便捷查看相关错误信息。

（1）提供包括请求的请求路径、状态码、请求耗时、消息和请求时间的日志信息，以列表的形式呈现

（2）用户可查看请求详情，详情还包括请求的id、调用地址、响应时间、源IP、请求头



## 三、与其他模块的关系
##### 告警模块

告警模块根据api的访问情况对用户进行告警

##### 监控模块

监控模块对api网关的相关情况进行监控

##### 应用管理模块

api网关需要绑定特定的应用，所以依赖应用管理模块

## 四、	功能点分析

|                用户故事                 |    功能点    |  M   |  S   |  C   |  W   | 约束 | 估时/人日 |
| :-------------------------------------: | :----------: | :--: | :--: | :--: | :--: | :--: | :-------: |
|  作为用户，我希望能够管理api的生命周期  |   创建api    |  Y   |      |      |      |      |     4     |
|                                         |   修改api    |  Y   |      |      |      |      |     1     |
|                                         |   删除api    |  Y   |      |      |      |      |     1     |
|                                         | 查看api详情  |  Y   |      |      |      |      |     2     |
|  作为用户，我希望能够配置api的相关策略  | 配置路由策略 |  Y   |      |      |      |      |     3     |
|                                         | 配置熔断策略 |  Y   |      |      |      |      |     3     |
|                                         | 配置流控策略 |  Y   |      |      |      |      |     2     |
| 作为用户，我希望能够对项目的api进行监控 | 查看流量统计 |  Y   |      |      |      |      |     2     |
|                                         | 查看请求日志 |  Y   |      |      |      |      |    1.5    |
